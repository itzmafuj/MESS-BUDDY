<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mess Buddy </title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1; --primary-soft: #eef2ff;
            --rose: #f43f5e; --rose-soft: #fff1f2;
            --emerald: #10b981; --emerald-soft: #ecfdf5;
            --amber: #f59e0b; --amber-soft: #fffbeb;
            --slate: #1e293b; --radius-xl: 32px;
        }

        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
        body { background: #f8fafc; margin: 0; padding-bottom: 110px; color: var(--slate); overflow-x: hidden; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tab-content { animation: fadeIn 0.4s ease-out; }

        #login-screen { position: fixed; inset: 0; background: linear-gradient(45deg, #0f172a, #1e293b); display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .login-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); padding: 3rem 2rem; border-radius: var(--radius-xl); width: 90%; max-width: 400px; text-align: center; color: white; }
        
        nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; background: white; padding: 8px; display: flex; z-index: 2000; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border: 1px solid #f1f5f9; }
        nav button { flex: 1; padding: 12px; border: none; background: transparent; color: #94a3b8; font-weight: 700; font-size: 0.7rem; border-radius: 20px; transition: 0.3s; }
        nav button.active { color: var(--primary); background: var(--primary-soft); }

        .container { padding: 20px; max-width: 700px; margin: 0 auto; }
        .card { background: white; border-radius: 24px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        
        .grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .stat-box { padding: 20px; border-radius: 22px; text-align: center; border: 1px solid rgba(0,0,0,0.02); }
        .stat-box span { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; }
        .stat-box h2 { margin: 5px 0 0; font-size: 1.4rem; font-weight: 800; }

        .blue { background: var(--primary-soft); color: var(--primary); }
        .red { background: var(--rose-soft); color: var(--rose); }
        .green { background: var(--emerald-soft); color: var(--emerald); }
        .gold { background: var(--amber-soft); color: var(--amber); }

        .table-wrap { overflow-x: auto; border-radius: 18px; }
        table { width: 100%; border-collapse: collapse; min-width: 450px; }
        th { text-align: left; padding: 15px 12px; font-size: 0.7rem; color: #94a3b8; background: #fcfcfd; }
        td { padding: 15px 12px; border-bottom: 1px solid #f8fafc; font-size: 0.85rem; }

        .edit-input { width: 100%; height: 54px; padding: 0 18px; border: 2px solid #f1f5f9; border-radius: 16px; font-size: 1rem; margin-bottom: 12px; transition: all 0.3s; }
        .btn { height: 54px; border: none; border-radius: 16px; font-weight: 800; cursor: pointer; width: 100%; background: var(--primary); color: white; transition: 0.3s; }
        
        .badge { padding: 8px 12px; border-radius: 12px; font-weight: 800; font-size: 0.7rem; border: none; }
        .clickable { cursor: pointer; }
        .hidden { display: none !important; }

        .toggle-filter { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: var(--primary); color: white; border-radius: 16px; margin-bottom: 15px; font-size: 0.85rem; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .toggle-filter input { width: 18px; height: 18px; cursor: pointer; }

        .dev-section { background: linear-gradient(135deg, #1e293b, #0f172a); color: white; border: none; display: flex; align-items: center; gap: 15px; }
        .dev-avatar { width: 50px; height: 50px; border-radius: 12px; background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 800; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h1 style="margin:0;">Mess Buddy</h1>
        <p style="opacity: 0.6; font-size: 0.8rem; margin-bottom: 25px;">"Your Mess, Simplified. Your Bills, Perfected."</p>
        
        <div id="first-time-area" class="hidden">
            <input type="text" id="v-name-input" placeholder="Enter Your Name" class="edit-input" style="background:rgba(255,255,255,0.1); color:white; border:none; text-align:center;">
        </div>
        <div id="returning-area" class="hidden">
            <p id="returning-msg" style="font-weight: 700; color: var(--emerald); margin-bottom: 15px;"></p>
        </div>

        <input type="password" id="pass" placeholder="Access Key" class="edit-input" style="background:rgba(255,255,255,0.1); color:white; border:none; text-align:center;">
        <button class="btn" onclick="checkLogin()">Unlock App</button>
    </div>
</div>

<div id="app" class="hidden">
    <div class="container">
        <div class="toggle-filter" onclick="togglePersonalView()">
            <span>✨ Show Only My Records</span>
            <input type="checkbox" id="personal-toggle" style="pointer-events:none;">
        </div>

        <div class="card" style="background: var(--primary); color: white; border: none; margin-bottom: 15px;">
            <h3 id="dash-greeting" style="margin:0;">Hello!</h3>
            <p id="live-date" style="margin:5px 0 0; font-size: 0.75rem; opacity: 0.8;"></p>
        </div>

        <nav>
            <button id="nav-dashboard" class="active" onclick="showTab('dashboard', this)">HOME</button>
            <button id="nav-meals" onclick="showTab('meals', this)">MEALS</button>
            <button id="nav-bazar" onclick="showTab('bazar', this)">COST</button>
            <button id="nav-members" onclick="showTab('members', this)">TEAM</button>
            <button id="nav-settings" class="admin-only hidden" onclick="showTab('settings', this)">ADMIN</button>
        </nav>

        <div id="tab-dashboard" class="tab-content">
            <div id="notice-display-card" class="card hidden" style="background:var(--primary-soft); border: 2px solid var(--primary);">
                <small style="color:var(--primary); font-weight:900;">NOTICE</small>
                <div id="current-notice" style="margin-top:5px; font-weight:700;"></div>
            </div>

            <div class="grid-stats">
                <div class="stat-box blue"><span>Actual Meals</span><h2 id="stat-meals">0</h2></div>
                <div class="stat-box red"><span>Total Cost</span><h2 id="stat-cost">₹0</h2></div>
                <div class="stat-box green"><span>Balance</span><h2 id="stat-balance">₹0</h2></div>
                <div class="stat-box gold"><span>Meal Rate</span><h2 id="stat-rate">0</h2></div>
            </div>

            <div class="card" style="display:flex; gap:10px; background:transparent; border:none; box-shadow:none; padding:0;">
                <select id="filter-month" class="edit-input" style="flex:2;" onchange="refreshUI()"></select>
                <select id="filter-year" class="edit-input" style="flex:1;" onchange="refreshUI()">
                    <option value="2025">2025</option><option value="2026" selected>2026</option>
                </select>
            </div>

            <div class="card" style="padding: 10px;">
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>MEMBER</th><th>DEPOSIT</th><th>MEALS</th><th>BILL</th><th>STATUS</th></tr></thead>
                        <tbody id="summary-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="qr-pay-card" class="card hidden" style="text-align:center;">
                <h4 style="margin:0 0 10px;">Scan to Settle</h4>
                <img id="generated-qr" src="" style="width:180px; height:180px; border-radius:15px; border:5px solid #f8fafc;">
                <p id="qr-upi-text" style="font-size:0.8rem; font-weight:700; color:var(--primary); margin-top:10px;"></p>
            </div>

            <div class="card dev-section">
                <div class="dev-avatar">MH</div>
                <div>
                    <div style="font-weight: 800; font-size: 0.9rem;">Mafuj Hossain</div>
                    <div style="font-size: 0.7rem; opacity: 0.7;">Technical Architect</div>
                    <a href="mailto:mafujhossain154@gmail.com" style="color: var(--primary); text-decoration: none; font-size: 0.75rem; font-weight: 700;">mafujhossain154@gmail.com</a>
                </div>
            </div>
        </div>

        <div id="tab-meals" class="tab-content hidden">
            <div class="card admin-only hidden"><h3>Daily Meals</h3><input type="date" id="meal-date" class="edit-input"><div id="meal-inputs-area"></div><button class="btn" onclick="saveDailyMeals()">Save Record</button></div>
            <div class="card" style="padding:5px;">
                <input type="text" id="meal-search" placeholder="Search date (e.g. 2026-02)..." class="edit-input" oninput="refreshUI()" style="margin:10px; width:calc(100% - 20px);">
                <div class="table-wrap"><table><thead id="meal-history-head"></thead><tbody id="meal-history-body"></tbody></table></div>
            </div>
        </div>

        <div id="tab-bazar" class="tab-content hidden">
            <div class="card admin-only hidden"><h3>Add Cost</h3><input type="date" id="b-date" class="edit-input"><input type="number" id="b-amt" placeholder="Amt" class="edit-input"><input type="text" id="b-note" placeholder="Item" class="edit-input"><button class="btn" style="background:var(--rose);" onclick="addBazar()">Save</button></div>
            <div class="card" style="padding:5px;"><div class="table-wrap"><table><tbody id="bazar-body"></tbody></table></div></div>
        </div>

        <div id="tab-members" class="tab-content hidden">
            <div class="card admin-only hidden">
                <h3>New Member</h3>
                <div style="display:flex; gap:5px;"><input type="text" id="new-mem-name" placeholder="NAME" class="edit-input" style="flex:2;"><input type="number" id="new-mem-min" placeholder="MIN" class="edit-input" style="flex:1;"></div>
                <button class="btn" onclick="addMember()">Add Member</button>
                <hr style="margin:20px 0;">
                <input type="date" id="dep-date" class="edit-input">
                <select id="dep-member" class="edit-input"></select>
                <input type="number" id="dep-amt" placeholder="Amt" class="edit-input">
                <button class="btn" style="background:var(--emerald);" onclick="addDeposit()">Deposit</button>
            </div>
            <div class="card" style="padding:15px;"><h4 style="margin:0 0 10px;">Deposit History</h4><div class="table-wrap"><table><tbody id="deposit-history-body"></tbody></table></div></div>
        </div>

        <div id="tab-settings" class="tab-content hidden">
            <div class="card"><h3>Settings</h3><input type="text" id="set-upi-id" class="edit-input" placeholder="UPI ID"><input type="text" id="set-admin-key" class="edit-input" placeholder="Admin Key"><input type="text" id="set-viewer-key" class="edit-input" placeholder="Viewer Key"><button class="btn" onclick="updateKeys()">Update</button><button class="btn" style="background:var(--slate); margin-top:10px;" onclick="resetIdentity()">Logout / Reset Name</button></div>
            <div class="card"><h3>Notice</h3><textarea id="notice-input" class="edit-input" style="height:80px;"></textarea>
                <div style="display:flex; gap:10px;">
                    <button class="btn" onclick="updateNotice()">Post</button>
                    <button class="btn" style="background:var(--rose); flex: 0.4;" onclick="deleteNotice()">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAnfWzHfN2qBGw68lOkTttSZ3Mz3D0T274",
        authDomain: "messmenegment.firebaseapp.com",
        databaseURL: "https://messmenegment-default-rtdb.firebaseio.com",
        projectId: "messmenegment",
        storageBucket: "messmenegment.firebasestorage.app",
        messagingSenderId: "365715103776",
        appId: "1:365715103776:web:32af4ed2537cb806341c45"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getDatabase(fbApp);
    const dataRef = ref(db, 'messData');

    let isAdmin = false;
    let data = { members: [], meals: {}, bazar: [], deposits: [], keys: { admin: "MESS2026", viewer: "MESSMEAL" } };
    let showOnlyMe = false;

    window.addEventListener('load', () => {
        const saved = localStorage.getItem('mb_name');
        if(saved) {
            document.getElementById('returning-area').classList.remove('hidden');
            document.getElementById('returning-msg').innerText = "Hello, " + saved + "!";
        } else {
            document.getElementById('first-time-area').classList.remove('hidden');
        }
    });

    window.togglePersonalView = () => {
        showOnlyMe = !showOnlyMe;
        document.getElementById('personal-toggle').checked = showOnlyMe;
        window.refreshUI();
    };

    window.checkLogin = () => {
        const pass = document.getElementById('pass').value.toUpperCase();
        const saved = localStorage.getItem('mb_name');
        const input = document.getElementById('v-name-input').value.trim();

        if(pass === data.keys.admin) { window.login(pass); } 
        else if(pass === data.keys.viewer) {
            const name = (saved || input).toUpperCase();
            if(!name) return alert("Enter your name!");
            localStorage.setItem('mb_name', name);
            window.login(pass);
        } else alert("Wrong Key");
    };

    window.login = (key) => {
        isAdmin = (key === data.keys.admin);
        const name = localStorage.getItem('mb_name') || "ADMIN";
        document.getElementById('dash-greeting').innerText = "Hello, " + name + "!";
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin));
        
        const mSel = document.getElementById('filter-month');
        if(mSel.options.length === 0) {
            const months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
            mSel.innerHTML = months.map((m, i) => `<option value="${m}">${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][i]}</option>`).join('');
            mSel.value = String(new Date().getMonth() + 1).padStart(2, '0');
        }
        document.getElementById('live-date').innerText = new Date().toDateString();
        window.refreshUI();
    };

    onValue(dataRef, (snap) => {
        const cloud = snap.val();
        if(cloud) { data = cloud; window.refreshUI(); window.refreshExtras(); }
    });

    window.refreshUI = () => {
        const m = document.getElementById('filter-month').value;
        const y = document.getElementById('filter-year').value;
        const filterStr = `${y}-${m}`;
        const myName = (localStorage.getItem('mb_name') || "").toUpperCase();
        const currentUserObj = (data.members || []).find(mem => mem.name === myName);
        
        let totalMeals = 0, totalBillable = 0, mActual = {}, mDeps = {}, income = 0;
        (data.members || []).forEach(mem => { mActual[mem.id] = 0; mDeps[mem.id] = 0; });
        (data.deposits || []).forEach(d => {
            if(d.date.startsWith(filterStr)) { mDeps[d.mId] += parseFloat(d.amt); income += parseFloat(d.amt); }
        });

        if(data.meals) {
            Object.entries(data.meals).forEach(([date, dayData]) => {
                if(date.startsWith(filterStr)) {
                    Object.entries(dayData).forEach(([id, q]) => { if(mActual[id] !== undefined) mActual[id] += q; });
                }
            });
        }

        const lastDay = new Date(y, m, 0).getDate();
        const lastDayStr = `${y}-${m}-${String(lastDay).padStart(2, '0')}`;
        const isMonthEnd = data.meals && data.meals[lastDayStr];

        const calc = (data.members || []).map(mem => {
            const act = mActual[mem.id] || 0;
            const min = mem.minMeal || 50;
            const bill = isMonthEnd ? (act < min ? min : act) : act;
            totalMeals += act; totalBillable += bill;
            return { ...mem, act, bill };
        });

        const cost = (data.bazar || []).reduce((s, b) => b.date.startsWith(filterStr) ? s + parseFloat(b.amt) : s, 0);
        const rate = totalBillable > 0 ? cost / totalBillable : 0;

        document.getElementById('stat-meals').innerText = Math.floor(totalMeals);
        document.getElementById('stat-cost').innerText = "₹" + cost;
        document.getElementById('stat-balance').innerText = "₹" + (income - cost).toFixed(0);
        document.getElementById('stat-rate').innerText = "₹" + rate.toFixed(2);

        // 1. HOME TABLE FILTER
        document.getElementById('summary-body').innerHTML = calc
            .filter(mem => !showOnlyMe || mem.name === myName)
            .map(mem => {
                const bill = mem.bill * rate;
                const net = bill - (mDeps[mem.id] || 0);
                const isDue = net > 0;
                return `<tr><td>${mem.name}</td><td>₹${mDeps[mem.id] || 0}</td><td>${mem.act}</td><td>₹${bill.toFixed(0)}</td>
                <td><button class="badge ${isDue?'clickable':''}" ${isDue?'onclick="window.scrollToQR()"':''} style="background:${isDue?'var(--rose-soft)':'var(--emerald-soft)'}; color:${isDue?'var(--rose)':'var(--emerald)'}">${isDue?'DUE ₹'+net.toFixed(0):'EXTRA ₹'+Math.abs(net).toFixed(0)}</button></td></tr>`;
            }).join('');

        // 2. MEAL HISTORY FILTER (Columns)
        const searchVal = document.getElementById('meal-search').value.toLowerCase();
        const dates = Object.keys(data.meals || {}).sort().reverse().filter(d => d.includes(searchVal));
        const filteredMembers = (data.members || []).filter(mem => !showOnlyMe || mem.name === myName);
        
        document.getElementById('meal-history-head').innerHTML = `<tr><th>DATE</th>${filteredMembers.map(mem => `<th>${mem.name.substring(0,3)}</th>`).join('')} ${isAdmin?'<th>DEL</th>':''}</tr>`;
        document.getElementById('meal-history-body').innerHTML = dates.map(d => `<tr><td>${d}</td>${filteredMembers.map(mem => `<td>${data.meals[d][mem.id] || 0}</td>`).join('')}${isAdmin?`<td><button onclick="window.delMeal('${d}')" style="background:none; border:none; color:var(--rose);">✕</button></td>`:''}</tr>`).join('');
        
        // 3. DEPOSIT HISTORY FILTER
        document.getElementById('deposit-history-body').innerHTML = (data.deposits || []).slice().reverse()
            .filter(d => {
                if(!showOnlyMe) return true;
                return currentUserObj && d.mId === currentUserObj.id;
            })
            .map((d, i) => {
                const mem = data.members.find(m => m.id == d.mId);
                return `<tr><td>${d.date}</td><td>${mem?mem.name:'?'}</td><td>₹${d.amt}</td>${isAdmin?`<td><button onclick="window.delDep(${data.deposits.length-1-i})" style="background:none; border:none; color:var(--rose);">✕</button></td>`:''}</tr>`;
            }).join('');

        // 4. BAZAR (Shared - No filter)
        document.getElementById('bazar-body').innerHTML = (data.bazar || []).slice().reverse().map((b, i) => `<tr><td>${b.date}</td><td>${b.note}</td><td>₹${b.amt}</td>${isAdmin?`<td><button onclick="window.delBazar(${data.bazar.length-1-i})" style="background:none; border:none; color:var(--rose);">✕</button></td>`:''}</tr>`).join('');

        document.getElementById('dep-member').innerHTML = (data.members || []).map(mem => `<option value="${mem.id}">${mem.name}</option>`).join('');
        if(isAdmin) {
            document.getElementById('meal-inputs-area').innerHTML = (data.members || []).map(mem => `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; ${showOnlyMe && mem.name !== myName ? 'opacity:0.3' : ''}">
                    <span>${mem.name}</span><input type="number" class="m-val edit-input" style="width:70px; margin:0;" data-id="${mem.id}" value="0">
                </div>
            `).join('');
        }
    };

    window.scrollToQR = () => document.getElementById('qr-pay-card').scrollIntoView({behavior:'smooth', block:'center'});
    window.refreshExtras = () => {
        if(data.upiId) {
            document.getElementById('generated-qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent('upi://pay?pa='+data.upiId+'&pn=MessBuddy&cu=INR')}`;
            document.getElementById('qr-upi-text').innerText = data.upiId;
            document.getElementById('qr-pay-card').classList.remove('hidden');
        }
        if(data.notice) { document.getElementById('current-notice').innerText = data.notice; document.getElementById('notice-display-card').classList.remove('hidden'); }
        else { document.getElementById('notice-display-card').classList.add('hidden'); }
    };

    window.showTab = (id, b) => { document.querySelectorAll('.tab-content').forEach(t=>t.classList.add('hidden')); document.getElementById('tab-'+id).classList.remove('hidden'); document.querySelectorAll('nav button').forEach(nb=>nb.classList.remove('active')); b.classList.add('active'); window.refreshUI(); };
    window.save = () => { if(isAdmin) set(dataRef, data); };
    window.delBazar = (i) => { if(confirm("Del?")) { data.bazar.splice(i,1); window.save(); } };
    window.delDep = (i) => { if(confirm("Del?")) { data.deposits.splice(i,1); window.save(); } };
    window.delMeal = (d) => { if(confirm("Del?")) { delete data.meals[d]; window.save(); } };
    window.saveDailyMeals = () => { const d = document.getElementById('meal-date').value; if(!d) return; const e = {}; document.querySelectorAll('.m-val').forEach(i=>e[i.dataset.id]=parseFloat(i.value)||0); if(!data.meals) data.meals={}; data.meals[d]=e; window.save(); alert("Saved"); };
    window.addBazar = () => { const d = document.getElementById('b-date').value, a = document.getElementById('b-amt').value, n = document.getElementById('b-note').value; if(d&&a) { if(!data.bazar) data.bazar=[]; data.bazar.push({date:d, amt:parseFloat(a), note:n}); window.save(); } };
    window.addMember = () => { const n = document.getElementById('new-mem-name').value, m = document.getElementById('new-mem-min').value; if(n) { if(!data.members) data.members=[]; data.members.push({id:Date.now(), name:n.toUpperCase(), minMeal:parseInt(m)||50}); window.save(); document.getElementById('new-mem-name').value=""; } };
    window.addDeposit = () => { const d = document.getElementById('dep-date').value, m = document.getElementById('dep-member').value, a = document.getElementById('dep-amt').value; if(d&&m&&a) { if(!data.deposits) data.deposits=[]; data.deposits.push({date:d, mId:parseInt(m), amt:parseFloat(a)}); window.save(); } };
    window.updateKeys = () => { const u = document.getElementById('set-upi-id').value, a = document.getElementById('set-admin-key').value.toUpperCase(), v = document.getElementById('set-viewer-key').value.toUpperCase(); if(a&&v) { data.upiId=u; data.keys={admin:a, viewer:v}; window.save(); alert("Saved"); } };
    window.updateNotice = () => { data.notice = document.getElementById('notice-input').value; window.save(); alert("Posted"); };
    window.deleteNotice = () => { if(confirm("Delete Notice?")) { data.notice = ""; window.save(); } };
    window.resetIdentity = () => { localStorage.removeItem('mb_name'); location.reload(); };
</script>
</body>
</html>
